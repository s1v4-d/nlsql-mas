name: nlsql-dev

services:
  db:
    image: pgvector/pgvector:pg16
    container_name: nlsql-postgres
    restart: unless-stopped
    shm_size: 256mb  # Needed for large index builds
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-retail_insights}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-retail_insights}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - backend

  redis:
    image: redis/redis-stack-server:latest
    container_name: nlsql-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    environment:
      - REDIS_ARGS=--save 60 1 --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  api:
    build:
      context: ..
      dockerfile: env-files/docker/Dockerfile.api
      target: development
    container_name: nlsql-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ../src:/app/src:ro
      - ../data:/app/data:ro
      - uv_cache:/root/.cache/uv
    env_file:
      - ./secrets/secrets.env
      - ./dev.env
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-retail_insights}
      REDIS_URL: redis://redis:6379/0
      DEBUG: "true"
      LOG_LEVEL: DEBUG
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    develop:
      watch:
        - action: sync
          path: ../src
          target: /app/src
          ignore:
            - __pycache__/
            - "*.pyc"
        - action: rebuild
          path: ../pyproject.toml
        - action: rebuild
          path: ../uv.lock
    networks:
      - frontend
      - backend

  ui:
    build:
      context: ..
      dockerfile: env-files/docker/Dockerfile.ui
    container_name: nlsql-ui
    restart: unless-stopped
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    volumes:
      - ../src/retail_insights/ui:/app/src/retail_insights/ui:ro
      - uv_cache:/root/.cache/uv
    env_file:
      - ./secrets/secrets.env
      - ./dev.env
    environment:
      API_URL: http://api:8000
    depends_on:
      api:
        condition: service_healthy
    develop:
      watch:
        - action: sync
          path: ../src/retail_insights/ui
          target: /app/src/retail_insights/ui
          ignore:
            - __pycache__/
            - "*.pyc"
    networks:
      - frontend

volumes:
  postgres_data:
    name: nlsql_postgres_data
    labels:
      com.nlsql.description: "PostgreSQL persistent data"
  redis_data:
    name: nlsql_redis_data
    labels:
      com.nlsql.description: "Redis persistent cache"
  uv_cache:
    name: nlsql_uv_cache
    labels:
      com.nlsql.description: "UV package cache for faster rebuilds"

networks:
  frontend:
    name: nlsql_frontend
    driver: bridge
  backend:
    name: nlsql_backend
    driver: bridge
